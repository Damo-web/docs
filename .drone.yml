---
kind: pipeline
name: drone

steps:
  # - name: restore-cache  
  #   image: drillster/drone-volume-cache  
  #   settings:  
  #     restore: true  
  #     mount:  
  #       - ./node_modules  
  #   volumes:  
  #     - name: cache  
  #       path: /cache  

  # - name: install
  #   image: node
  #   commands:
  #     # https://github.com/yarnpkg/yarn/issues/5163
  #     # - yarn cache clean
  #     # - yarn config set registry https://registry.yarnpkg.com
  #     # - yarn config get registry
  #     - curl ip.gs
  #     - bash ./build/pre-install.sh
  #     # - yarn pre-run
  #     # - git diff HEAD~2 HEAD -- yarn.lock
  #     # - yarn config set registry 'https://registry.npm.taobao.org'
  #     # - yarn install --production=true

  - name: buiild-web-image
    image: harbor.snowball.site/web/node-base
    # 挂载主机 daemon 用来 tag
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    environment:
      HARBOR_USERNAME:
        from_secret: HARBOR_USERNAME
      HARBOR_PWD:
        from_secret: HARBOR_PWD
    commands: 
      # node 基础镜像没内置 git 和 docker
      - apk add --no-cache git
      - apk add docker
      - docker login harbor.snowball.site -u $$HARBOR_USERNAME -p $$HARBOR_PWD
      - sh ./build/auto-check.sh
      - docker build -t web-nginx -f web.dockerfile .
      - docker tag web-nginx harbor.snowball.site/web/web-nginx
      - docker push harbor.snowball.site/web/web-nginx
    privileged: true

  - name: async-web-image
    image: drillster/drone-rsync
    environment:
      HARBOR_USERNAME:
        from_secret: HARBOR_USERNAME
      HARBOR_PWD:
        from_secret: HARBOR_PWD
      RSYNC_KEY:
        from_secret: RSYNC_KEY
      RSYNC_USER:
        from_secret: RSYNC_USER
      REMOTE_HOST:
        from_secret: REMOTE_HOST
    settings:
      hosts:
        - $$REMOTE_HOST
      secrets: [ RSYNC_KEY,HARBOR_USERNAME,HARBOR_PWD ]
      source: ./
      target: ~/
      script:
        - echo ${HARBOR_USERNAME}
        # - docker login harbor.snowball.site -u $$HARBOR_USERNAME -p $$HARBOR_PWD
        # - docker pull harbor.snowball.site/web/web-nginx
        # - echo "pull finished"
        # - docker run -d -p 3080:80 --name web-server harbor.snowball.site/web/web-nginx

  # - name: build
  #   image: harbor.snowball.site/web/node-base
  #   environment:
  #     HARBOR_USERNAME:
  #       from_secret: HARBOR_USERNAME
  #     HARBOR_PWD:
  #       from_secret: HARBOR_PWD
  #   commands:
  #     - apk add docker
  #     - docker login harbor.snowball.site -u $$HARBOR_USERNAME -p $$HARBOR_PWD
  #     - docker build -t web-nginx -f web.dockerfile .
  #     - docker tag web-nginx harbor.snowball.site/web/web-nginx
  #     - docker push harbor.snowball.site/web/web-nginx
  #   privileged: true

  # - name: deploy
  #   image: node
  #   commands:
  #     - cd ./dist
  #     - ls
  #     - git init
  #     - git config user.name $${USERNAME}
  #     - git config user.email $${EMAIL}
  #     - git add -A
  #     - git commit -m "[skip ci] deploy"
  #     - git push -f https://$${GH_TOKEN}@$${GH_REF} master:gh-pages
  #   environment:
  #     USERNAME:
  #       from_secret: USERNAME
  #     EMAIL:
  #       from_secret: EMAIL
  #     GH_REF:
  #       from_secret: GH_REF
  #     GH_TOKEN:
  #       from_secret: GH_TOKEN
  # - name: rebuild-cache  
  #   image: drillster/drone-volume-cache  
  #   settings:  
  #     rebuild: true  
  #     mount:    
  #       - ./node_modules  
  #   volumes:  
  #     - name: cache  
  #       path: /cache
  # - name: rsync
  #   image: drillster/drone-rsync
  #   environment:
  #     RSYNC_KEY:
  #       from_secret: RSYNC_KEY
  #     RSYNC_USER:
  #       from_secret: RSYNC_USER
  #     REMOTE_HOST:
  #       from_secret: REMOTE_HOST
  #     REMOTE_HOST2:
  #       from_secret: REMOTE_HOST2
  #   settings:
  #     hosts:
  #       - $$REMOTE_HOST
  #       - $$REMOTE_HOST2
  #     source: ./dist
  #     target: ~/nginx
  #     script:
  #       - cd ~/nginx
  #       # - docker ps
  #       - docker container stop web-server
  #       - docker rm -f web-server
  #       - docker build -t damo-docs .
  #       - docker run -d -p 3080:80 --name web-server damo-docs
  # - name: slack
  #   image: plugins/slack
  #   settings:
  #     webhook:
  #       from_secret: SLACK_WEB_HOOK
  #     channel: web-notification
  #     template: >
  #       {{#success build.status}}
  #        Repo `{{repo.name}}`build (<{{build.link}}|#{{build.number}}>) for commit(<{{build.link}}|{{truncate build.commit 7}}>) 
  #        on branch `{{build.branch}}` by `{{build.author}}`
  #        Execution time: *{{since job.started}}*
  #        Message: *The build {{build.status}}*
  #       {{else}}
  #         build {{build.number}} failed. Fix me please.
  #       {{/success}} 
image_pull_secrets:
  - dockerconfigjson

trigger:
  branch:
    - master
  event:
    - push

volumes:
  - name: cache
    host:
      path: /var/drone-cache
  - name: dockersock
    host:
      path: /var/run/docker.sock


