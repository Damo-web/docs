<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack Optimization | Damo</title>
    <meta name="description" content="达摩院文档平台">
    <link rel="shortcut icon" type="image/x-icon" href="/docs/favicon.ico">
  <link rel="manifest" href="/docs/manifest.json">
    
    <link rel="preload" href="/docs/assets/css/0.styles.ba6021e1.css" as="style"><link rel="preload" href="/docs/assets/js/app.bb5e32e8.js" as="script"><link rel="preload" href="/docs/assets/js/2.3b5bc873.js" as="script"><link rel="preload" href="/docs/assets/js/20.0911ce1c.js" as="script"><link rel="preload" href="/docs/assets/js/22.e56f6488.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.e79ac61c.js"><link rel="prefetch" href="/docs/assets/js/11.231bcbc2.js"><link rel="prefetch" href="/docs/assets/js/12.c158b58e.js"><link rel="prefetch" href="/docs/assets/js/13.4d87ce46.js"><link rel="prefetch" href="/docs/assets/js/14.7c9ff823.js"><link rel="prefetch" href="/docs/assets/js/15.6db4bdac.js"><link rel="prefetch" href="/docs/assets/js/16.a5e840e7.js"><link rel="prefetch" href="/docs/assets/js/17.ec94b3d5.js"><link rel="prefetch" href="/docs/assets/js/18.fae32894.js"><link rel="prefetch" href="/docs/assets/js/19.0616547f.js"><link rel="prefetch" href="/docs/assets/js/21.2f377134.js"><link rel="prefetch" href="/docs/assets/js/23.a4767746.js"><link rel="prefetch" href="/docs/assets/js/24.00d42de4.js"><link rel="prefetch" href="/docs/assets/js/25.e565c20f.js"><link rel="prefetch" href="/docs/assets/js/26.ba96a6e3.js"><link rel="prefetch" href="/docs/assets/js/27.11a11261.js"><link rel="prefetch" href="/docs/assets/js/28.b49aaaba.js"><link rel="prefetch" href="/docs/assets/js/29.2e6a7a2d.js"><link rel="prefetch" href="/docs/assets/js/3.b55da558.js"><link rel="prefetch" href="/docs/assets/js/30.8ea5fdcf.js"><link rel="prefetch" href="/docs/assets/js/31.bb57c422.js"><link rel="prefetch" href="/docs/assets/js/32.bc41411c.js"><link rel="prefetch" href="/docs/assets/js/33.5ad4e0f7.js"><link rel="prefetch" href="/docs/assets/js/34.e046d4c9.js"><link rel="prefetch" href="/docs/assets/js/35.9fe3872e.js"><link rel="prefetch" href="/docs/assets/js/36.ba8de101.js"><link rel="prefetch" href="/docs/assets/js/37.854a398e.js"><link rel="prefetch" href="/docs/assets/js/38.bfd940cf.js"><link rel="prefetch" href="/docs/assets/js/39.599fa4d5.js"><link rel="prefetch" href="/docs/assets/js/4.ca28c6e7.js"><link rel="prefetch" href="/docs/assets/js/40.f4157755.js"><link rel="prefetch" href="/docs/assets/js/41.d78fffc0.js"><link rel="prefetch" href="/docs/assets/js/5.d10ece1f.js"><link rel="prefetch" href="/docs/assets/js/6.b76f823f.js"><link rel="prefetch" href="/docs/assets/js/7.b57c8ee5.js"><link rel="prefetch" href="/docs/assets/js/8.bc6cdd57.js"><link rel="prefetch" href="/docs/assets/js/9.454003ec.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.ba6021e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Damo</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/platform/" class="nav-link">跨端</a></div><div class="nav-item"><a href="/docs/server/" class="nav-link">服务端</a></div><div class="nav-item"><a href="/docs/framework/" class="nav-link">框架</a></div><div class="nav-item"><a href="/docs/engineering/" class="nav-link router-link-exact-active router-link-active">工程化</a></div><div class="nav-item"><a href="/docs/render/" class="nav-link">渲染</a></div><div class="nav-item"><a href="/docs/media/" class="nav-link">互动媒体</a></div> <a href="https://github.com/Damo-web/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/platform/" class="nav-link">跨端</a></div><div class="nav-item"><a href="/docs/server/" class="nav-link">服务端</a></div><div class="nav-item"><a href="/docs/framework/" class="nav-link">框架</a></div><div class="nav-item"><a href="/docs/engineering/" class="nav-link router-link-exact-active router-link-active">工程化</a></div><div class="nav-item"><a href="/docs/render/" class="nav-link">渲染</a></div><div class="nav-item"><a href="/docs/media/" class="nav-link">互动媒体</a></div> <a href="https://github.com/Damo-web/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>文章列表</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/engineering/" class="active sidebar-link">Webpack Optimization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/engineering/#起因" class="sidebar-link">起因</a></li><li class="sidebar-sub-header"><a href="/docs/engineering/#热更新" class="sidebar-link">热更新</a></li><li class="sidebar-sub-header"><a href="/docs/engineering/#构建时" class="sidebar-link">构建时</a></li><li class="sidebar-sub-header"><a href="/docs/engineering/#构建后" class="sidebar-link">构建后</a></li><li class="sidebar-sub-header"><a href="/docs/engineering/#上线后" class="sidebar-link">上线后</a></li><li class="sidebar-sub-header"><a href="/docs/engineering/#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/docs/engineering/eslint.html" class="sidebar-link">ESLint</a></li><li><a href="/docs/engineering/stylelint.html" class="sidebar-link">StyleLint</a></li><li><a href="/docs/engineering/easymock.html" class="sidebar-link">EasyMock</a></li><li><a href="/docs/engineering/staticsite.html" class="sidebar-link">Static Site Generator</a></li><li><a href="/docs/engineering/ci.html" class="sidebar-link">CI / CD</a></li><li><a href="/docs/engineering/jenkins.html" class="sidebar-link">Jenkins CI</a></li><li><a href="/docs/engineering/drone.html" class="sidebar-link">Drone CI</a></li><li><a href="/docs/engineering/circle.html" class="sidebar-link">Circle CI</a></li><li><a href="/docs/engineering/travis.html" class="sidebar-link">Travis CI</a></li><li><a href="/docs/engineering/harbor.html" class="sidebar-link">Harbor</a></li><li><a href="/docs/engineering/build.html" class="sidebar-link">Build Optimization</a></li><li><a href="/docs/engineering/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/docs/engineering/domain.html" class="sidebar-link">Domain</a></li><li><a href="/docs/engineering/cdn.html" class="sidebar-link">CDN</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-optimization"><a href="#webpack-optimization" aria-hidden="true" class="header-anchor">#</a> Webpack Optimization</h1> <blockquote><p>本篇目着重于 Webpack 速度及性能优化。暂时记录下 webpack V2版本相关的性能及构建用时优化，webpack V4版本相关优化后续补充。</p></blockquote> <h2 id="起因"><a href="#起因" aria-hidden="true" class="header-anchor">#</a> 起因</h2> <p>中后台应用中因npm包体量重、模块众多、组件颗粒度细腻，导致开发时遇到两大突出问题：</p> <ul><li><p>热更新速度缓慢，长达10s左右</p></li> <li><p>构建用时过长，长达200s左右</p></li></ul> <h2 id="热更新"><a href="#热更新" aria-hidden="true" class="header-anchor">#</a> 热更新</h2> <p>在 Webpack v2版本中，当项目模块（ chunks ）众多时，热更新耗时主要用于 Webpack 内置插件 RemoveParentModulesPlugin 。</p> <p>具体详情可参阅：<a href="https://github.com/webpack/webpack/issues/6248" target="_blank" rel="noopener noreferrer">RemoveParentModulesPlugin takes a long time with hundreds of chunks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>阅读上述 issue ，可知 RemoveParentModulesPlugin 在 Webpack V2版本中会存在性能问题，在进一步查阅 Webpack 2.7 版本源码后，更加确认了此问题的存在。相关源码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">RemoveParentModulesPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;optimize-chunks-basic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;optimize-extracted-chunks-basic&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunks</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> chunk <span class="token operator">=</span> chunks<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>parents<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

          <span class="token comment">// TODO consider Map when performance has improved https://gist.github.com/sokra/b36098368da7b8f6792fd7c85fca6311</span>
          <span class="token keyword">var</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> modules <span class="token operator">=</span> chunk<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> module <span class="token operator">=</span> modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> dId <span class="token operator">=</span> <span class="token function">debugIds</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> parentChunksWithModule<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dId <span class="token keyword">in</span> cache<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dId <span class="token operator">!==</span> <span class="token string">&quot;no&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              parentChunksWithModule <span class="token operator">=</span> cache<span class="token punctuation">[</span>dId<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              parentChunksWithModule <span class="token operator">=</span> cache<span class="token punctuation">[</span>dId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">allHaveModule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>parents<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>parentChunksWithModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              module<span class="token punctuation">.</span><span class="token function">rewriteChunkInReasons</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> parentChunksWithModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
              chunk<span class="token punctuation">.</span><span class="token function">removeModule</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>因项目迁移至 Webpack V4版本，成本巨大，具有风险，只能在 Webpack V2版本进行打补丁式处理。</p> <p>而在开发模式下，其实并不需要 RemoveParentModulesPlugin 提供的优化，故可以使用自定义插件来避免此次优化。相关代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">OptimizeChunkTraversePlugin</span><span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// apply the plugin in webpack &lt; 4 </span>
    <span class="token comment">// webpack4+ fixed this performance bug</span>
    <span class="token comment">// Reference: https://github.com/webpack/webpack/issues/6248</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'compilation'</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// optimize webpack built-in plugin : RemoveParentModulesPlugin</span>
        compilation<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'optimize-chunks-basic'</span><span class="token punctuation">,</span> <span class="token string">'optimize-extracted-chunks-basic'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">chunks</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            chunk<span class="token punctuation">.</span>parents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过此次优化，热更新耗时从 10s 下降至 2s，避免了之前开发过程中漫长等待。</p> <h2 id="构建时"><a href="#构建时" aria-hidden="true" class="header-anchor">#</a> 构建时</h2> <p>在 Webpack v2版本中，关于构建时长的分析主要通过 <a href="https://github.com/webpack-contrib/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer">webpack-bundle-analyzer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 及 <a href="https://github.com/stephencookdev/speed-measure-webpack-plugin#readme" target="_blank" rel="noopener noreferrer">speed-measure-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 两个插件来进行，前者主要用于分析打包后各模块的体积和模块间的依赖关系，后者主要用于分析相关 plugin 及 loader 的运行时长。</p> <p><strong>优化前打包结果如下：</strong></p> <p><img src="/docs/assets/img/webpack_optimization_1.de3e8268.png" alt=""></p> <p>通过上述两个插件分析，针对项目进行了如下优化：</p> <ul><li>包体积</li></ul> <ol><li><p>首先需要做得，即不常用的第三方库采用 CDN 来进行引入。</p></li> <li><p>其次，针对于已引入并在项目中大量使用的库，为了避免代码变动导致的影响，采用 DllPlugin 来进行预打包，而为了区分开发与生产环境的差异性，引入了 <a href="https://github.com/asfktz/autodll-webpack-plugin#readme" target="_blank" rel="noopener noreferrer">autodll-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></li></ol> <ul><li>缓存</li></ul> <ol><li>loader 缓存，主要是开启 babel-loader 的 cache模式</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
  loader<span class="token punctuation">:</span> <span class="token string">'babel-loader?cacheDirectory=true'</span><span class="token punctuation">,</span>
  include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li><p>uglify 缓存，主要是开启 UglifyJSPlugin 的 cache模式</p></li> <li><p>docker（ Jenkins ）中 node_modules 缓存</p></li></ol> <ul><li>多线程</li></ul> <ol><li><p>happyPack：用于多线程加速 loader 解析</p></li> <li><p>webpack-parallel-uglify-plugin：用于多线程加速 uglify 过程</p></li></ol> <p><strong>优化后打包结果如下：</strong></p> <p><img src="/docs/assets/img/webpack_optimization_2.1bba76e7.png" alt=""></p> <h2 id="构建后"><a href="#构建后" aria-hidden="true" class="header-anchor">#</a> 构建后</h2> <p>优化结束后，构建完出现下述错误：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token constant">ERROR</span> <span class="token keyword">in</span> <span class="token keyword">static</span><span class="token operator">/</span>js<span class="token operator">/</span><span class="token number">22.32e9</span>e1b9c0f91bace1a9<span class="token punctuation">.</span>js <span class="token keyword">from</span> UglifyJs
Unexpected token<span class="token punctuation">:</span> <span class="token function">name</span> <span class="token punctuation">(</span>hiddenTextarea<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token keyword">static</span><span class="token operator">/</span>js<span class="token operator">/</span><span class="token number">22.32e9</span>e1b9c0f91bace1a9<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>

</code></pre></div><p>参阅 <a href="https://github.com/webpack/webpack/issues/2972" target="_blank" rel="noopener noreferrer">SyntaxError: Unexpected token: name (xxxxxx) from Uglify plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，得知 Uglify 并不能解析 ES6，因此抛出错误语法。</p> <p>为解决此类问题，引入 <a href="https://github.com/webpack-contrib/babel-minify-webpack-plugin#readme" target="_blank" rel="noopener noreferrer">babili-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 <a href="https://github.com/gdborton/webpack-parallel-uglify-plugin#readme" target="_blank" rel="noopener noreferrer">webpack-parallel-uglify-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 替换 Webpack 内置 UglifyJsPlugin 便可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 如下插件择一即可</span>
<span class="token keyword">const</span> UglifyJSPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> BabiliPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;babili-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

plugins<span class="token punctuation">:</span><span class="token punctuation">[</span>
  <span class="token operator">...</span>
  <span class="token keyword">new</span> <span class="token class-name">BabiliPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">UglifyJSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    uglifyES<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span>

</code></pre></div><h2 id="上线后"><a href="#上线后" aria-hidden="true" class="header-anchor">#</a> 上线后</h2> <p>优化项部署到生产环境后，中后台控制台出现以下错误：</p> <p><img src="/docs/assets/img/webpack_optimization_3.888b0b76.png" alt=""></p> <p>参阅以下文章：</p> <ul><li><p><a href="https://github.com/vuejs/vue/issues/6698" target="_blank" rel="noopener noreferrer">[Vue warn]: $attrs is readonly,$listeners is readonly<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://forum.vuejs.org/t/vue-warn-attrs-is-readonly/18053/7" target="_blank" rel="noopener noreferrer">[Vue warn]: $attrs is readonly<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://github.com/ElemeFE/element/issues/9104" target="_blank" rel="noopener noreferrer">[Bug Report] $listeners is readonly<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://segmentfault.com/q/1010000010759119" target="_blank" rel="noopener noreferrer">iview Date-picker 点击报“$attrs is readonly”错误<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <p>最初做了 element-ui 依赖 Vue 版本和项目中现有 Vue 版本统一尝试，发现并没有解决问题。</p> <p>之后，考虑到可能是 Webpack 打包时索引 Vue 的问题，改变了索引项，如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue/dist/vue.esm.js'</span>
</code></pre></div><p>发现依旧没有解决，两次尝试后，基本可以把问题聚焦于预打包后的 vendor 中 Vue 的问题。</p> <p>当 Vue 全局化后，node_modules 下其他包有依赖其他版本的 Vue 时，打包后就会出现类似的问题，可以通过如下命令来查看依赖 Vue 的相关包。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm ls vue
</code></pre></div><p>解决办法即是使用 AutoDllPlugin 预打包时不打包 Vue :</p> <div class="language-diff extra-class"><pre class="language-diff"><code>new AutoDllPlugin({
<span class="token unchanged">  inject: true,
  filename: '[name].js',
  context: path.join(__dirname, '..'),
  entry: {
    vendor: [
</span><span class="token deleted-sign deleted">-     'vue/dist/vue.esm.js',
</span><span class="token unchanged">      'vuex', 
      'vue-router', 
      'axios', 
      'element-ui',
      'moment'
    ]
  },
  plugins:[
    new webpack.optimize.UglifyJsPlugin()
  ]
</span>})
</code></pre></div><h2 id="参考链接"><a href="#参考链接" aria-hidden="true" class="header-anchor">#</a> 参考链接</h2> <ul><li><p><a href="https://stackoverflow.com/questions/43341878/slow-webpack-build-time-advanced-module-optimization" target="_blank" rel="noopener noreferrer">Slow webpack build time (advanced module optimization)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://github.com/webpack/webpack/issues/6248" target="_blank" rel="noopener noreferrer">RemoveParentModulesPlugin takes a long time with hundreds of chunks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://github.com/webpack/webpack/issues/2972" target="_blank" rel="noopener noreferrer">SyntaxError: Unexpected token: name (xxxxxx) from Uglify plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://github.com/vuejs/vue/issues/6698" target="_blank" rel="noopener noreferrer">[Vue warn]: $attrs is readonly,$listeners is readonly<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Damo-web/docs/edit/master/docs/engineering/README.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-06-21 07:32:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/engineering/eslint.html">ESLint</a>→
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.bb5e32e8.js" defer></script><script src="/docs/assets/js/2.3b5bc873.js" defer></script><script src="/docs/assets/js/20.0911ce1c.js" defer></script><script src="/docs/assets/js/22.e56f6488.js" defer></script>
  </body>
</html>
