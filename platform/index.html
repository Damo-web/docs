<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Virtual DOM | Damo</title>
    <meta name="description" content="达摩院文档平台">
    <link rel="shortcut icon" type="image/x-icon" href="/docs/favicon.ico">
  <link rel="manifest" href="/docs/manifest.json">
    
    <link rel="preload" href="/docs/assets/css/0.styles.ba6021e1.css" as="style"><link rel="preload" href="/docs/assets/js/app.bb5e32e8.js" as="script"><link rel="preload" href="/docs/assets/js/2.3b5bc873.js" as="script"><link rel="preload" href="/docs/assets/js/5.d10ece1f.js" as="script"><link rel="preload" href="/docs/assets/js/22.e56f6488.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.e79ac61c.js"><link rel="prefetch" href="/docs/assets/js/11.231bcbc2.js"><link rel="prefetch" href="/docs/assets/js/12.c158b58e.js"><link rel="prefetch" href="/docs/assets/js/13.4d87ce46.js"><link rel="prefetch" href="/docs/assets/js/14.7c9ff823.js"><link rel="prefetch" href="/docs/assets/js/15.6db4bdac.js"><link rel="prefetch" href="/docs/assets/js/16.a5e840e7.js"><link rel="prefetch" href="/docs/assets/js/17.ec94b3d5.js"><link rel="prefetch" href="/docs/assets/js/18.fae32894.js"><link rel="prefetch" href="/docs/assets/js/19.0616547f.js"><link rel="prefetch" href="/docs/assets/js/20.0911ce1c.js"><link rel="prefetch" href="/docs/assets/js/21.2f377134.js"><link rel="prefetch" href="/docs/assets/js/23.a4767746.js"><link rel="prefetch" href="/docs/assets/js/24.00d42de4.js"><link rel="prefetch" href="/docs/assets/js/25.e565c20f.js"><link rel="prefetch" href="/docs/assets/js/26.ba96a6e3.js"><link rel="prefetch" href="/docs/assets/js/27.11a11261.js"><link rel="prefetch" href="/docs/assets/js/28.b49aaaba.js"><link rel="prefetch" href="/docs/assets/js/29.2e6a7a2d.js"><link rel="prefetch" href="/docs/assets/js/3.b55da558.js"><link rel="prefetch" href="/docs/assets/js/30.8ea5fdcf.js"><link rel="prefetch" href="/docs/assets/js/31.bb57c422.js"><link rel="prefetch" href="/docs/assets/js/32.bc41411c.js"><link rel="prefetch" href="/docs/assets/js/33.5ad4e0f7.js"><link rel="prefetch" href="/docs/assets/js/34.e046d4c9.js"><link rel="prefetch" href="/docs/assets/js/35.9fe3872e.js"><link rel="prefetch" href="/docs/assets/js/36.ba8de101.js"><link rel="prefetch" href="/docs/assets/js/37.854a398e.js"><link rel="prefetch" href="/docs/assets/js/38.bfd940cf.js"><link rel="prefetch" href="/docs/assets/js/39.599fa4d5.js"><link rel="prefetch" href="/docs/assets/js/4.ca28c6e7.js"><link rel="prefetch" href="/docs/assets/js/40.f4157755.js"><link rel="prefetch" href="/docs/assets/js/41.d78fffc0.js"><link rel="prefetch" href="/docs/assets/js/6.b76f823f.js"><link rel="prefetch" href="/docs/assets/js/7.b57c8ee5.js"><link rel="prefetch" href="/docs/assets/js/8.bc6cdd57.js"><link rel="prefetch" href="/docs/assets/js/9.454003ec.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.ba6021e1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Damo</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/platform/" class="nav-link router-link-exact-active router-link-active">跨端</a></div><div class="nav-item"><a href="/docs/server/" class="nav-link">服务端</a></div><div class="nav-item"><a href="/docs/framework/" class="nav-link">框架</a></div><div class="nav-item"><a href="/docs/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/docs/render/" class="nav-link">渲染</a></div><div class="nav-item"><a href="/docs/media/" class="nav-link">互动媒体</a></div> <a href="https://github.com/Damo-web/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/platform/" class="nav-link router-link-exact-active router-link-active">跨端</a></div><div class="nav-item"><a href="/docs/server/" class="nav-link">服务端</a></div><div class="nav-item"><a href="/docs/framework/" class="nav-link">框架</a></div><div class="nav-item"><a href="/docs/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/docs/render/" class="nav-link">渲染</a></div><div class="nav-item"><a href="/docs/media/" class="nav-link">互动媒体</a></div> <a href="https://github.com/Damo-web/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>文章列表</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/platform/" class="active sidebar-link">Virtual DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/platform/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#diff算法" class="sidebar-link">Diff算法</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#diff源码" class="sidebar-link">Diff源码</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#diff逻辑图" class="sidebar-link">Diff逻辑图</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#updatechildren流程图" class="sidebar-link">UpdateChildren流程图</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#总论" class="sidebar-link">总论</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#参考链接" class="sidebar-link">参考链接</a></li><li class="sidebar-sub-header"><a href="/docs/platform/#附录" class="sidebar-link">附录</a></li></ul></li><li><a href="/docs/platform/vueLoader.html" class="sidebar-link">Vue Loader</a></li><li><a href="/docs/platform/templateCompiler.html" class="sidebar-link">Template Compiler</a></li><li><a href="/docs/platform/htmlParser.html" class="sidebar-link">HTML Parser</a></li><li><a href="/docs/platform/postcss.html" class="sidebar-link">PostCSS</a></li><li><a href="/docs/platform/babel.html" class="sidebar-link">Babel</a></li><li><a href="/docs/platform/mpcli.html" class="sidebar-link">MP CLI</a></li><li><a href="/docs/platform/jsonParser.html" class="sidebar-link">JSON Parser</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> Virtual DOM</h1> <blockquote><p>在现代web前端框架中，虚拟DOM是一个不可避免谈论的话题。初识虚拟DOM，会对它非常好奇，但大部分人可能只停留在框架使用层面，对其diff过程不太清楚。本栏目旨在实现类mpVue类的跨端平台简易版本，会持续进行文档记录。而首当其冲，需要去了解Vue2.0+版本背后，虚拟DOM的运行机制及原理。</p></blockquote> <p>当翻阅Vue的源码，在其<a href="https://github.com/vuejs/vue" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上dev分支vue/src/core/vdom/patch.js目录下，注明了Vue有关虚拟DOM的diff算法是借鉴<a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">Snabbdom<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>这个开源库来实现的。
下述文档会就Snabbdom的diff算法进行源码层面的分析和解读。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * Virtual DOM patching algorithm based on Snabbdom by
 * Simon Friis Vindum (@paldepind)
 * Licensed under the MIT License
 * https://github.com/paldepind/snabbdom/blob/master/LICENSE
 *
 * modified by Evan You (@yyx990803)
 *
 * Not type-checking this because this file is perf-critical and the cost
 * of making flow understand it is not worth it.
 */</span>
</code></pre></div><h2 id="简介"><a href="#简介" aria-hidden="true" class="header-anchor">#</a> 简介</h2> <p>虚拟DOM本质是真实DOM抽象化，实质是用 JS 对象的方式来模拟真实的 DOM及节点。大体如下：</p> <p><img src="/docs/assets/img/vdom_1.a2085b6f.png" alt=""></p> <h2 id="diff算法"><a href="#diff算法" aria-hidden="true" class="header-anchor">#</a> Diff算法</h2> <p>虚拟DOM其实就是模拟真实的 DOM 的 JS 对象，但仅有DOM抽象化模型，无法解决Web UI操作更新DOM后所引发页面渲染问题。为了解决页面操作引发更新DOM的问题，<strong>还需要对前后两次DOM节点变化进行对比，计算出虚拟DOM中真正变化的部分，并针对该部分进行真实 DOM 操作</strong>，而非一更新DOM全部重新渲染页面。而上述这个比对并更新DOM的过程，就是虚拟DOM中的Diff算法。</p> <p>将一棵树转换成另一棵树的最小操作次数，<strong>传统Diff算法是通过循环递归对节点进行依次对比，算法复杂度达到 O(n^3)</strong>，其中 n 是树中节点的总数。传统Diff算法，论性能及效率，在前端渲染层是难以接受的。</p> <p>React 通过以下的约定，实现了<strong>算法复杂度从O(n^3)降到O(n)</strong>，保证了UI渲染的性能:</p> <p><strong>1. 不同类型的节点将生成不同的DOM Tree</strong></p> <p><strong>2. 对于同一层级的一组子节点，它们可以通过唯一 Key 进行区分</strong></p> <p><strong>3. DOM 节点跨层级的操作特别少，可以忽略，即使出现，删除旧节点新建DOM节点即可</strong></p> <img src="data:image/png;base64,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" width="100%"> <h2 id="diff源码"><a href="#diff源码" aria-hidden="true" class="header-anchor">#</a> Diff源码</h2> <p>Snabbdom关于虚拟DOM及Diff算法与React其实是类似的。下文以Snabbdom为例，从代码层面剖析了构建虚拟DOM 及 Diff的过程：</p> <ul><li>DOM抽象化模型vnode</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">/**
 * 虚拟DOM生成函数
 * @param {selector}                元素选择器
 * @param {data}                    元素标签属性及key
 * @param {children}                元素子元素
 * @param {text}                    元素纯文本节点                    
 * @param {elm}                     元素真实dom（render时）
 */</span>

  <span class="token keyword">const</span> <span class="token function-variable function">VNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token punctuation">:</span> data<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      selector<span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
      elm<span class="token punctuation">,</span>
      text<span class="token punctuation">,</span>
      key
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p>值得注意的是，Snabbdom约定了text与children不可并存，作为区分文本节点和非文本节点的标志,当text与children共存时，忽略text属性</p></div> <ul><li>新旧节点patch</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> elm<span class="token punctuation">,</span>parent<span class="token punctuation">;</span>

    <span class="token comment">//若oldVnode为 真实Element</span>
    <span class="token comment">//则转化oldVnode为空节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//对比新旧节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//新旧节点为相同节点(selector和key相同)则patch</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//获取新旧节点及父级</span>
      elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
      parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//倘若父级节点存在</span>
      <span class="token comment">//在父级节点下旧节点后插入新节点</span>
      <span class="token comment">//删除旧节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>新旧节点patchVnode</li></ul> <div class="language-javascript code-contain extra-class"><pre class="language-javascript"><code>  <span class="token comment">//patch node</span>
  <span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> hook<span class="token punctuation">;</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

    <span class="token comment">//若data.hook.prepatch存在，则执行prepatch hook</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//新旧节点完全相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//触发update hook</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//新节点非文本节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//新旧节点都含有子元素</span>
        <span class="token comment">//则更新子元素</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//新节点有子元素，旧节点无子元素</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//新节点无子元素，旧节点有子元素</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//旧节点为文本节点</span>
        api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//新节点为文本节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//若data.hook.postpatch存在，则执行postpatch hook</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> hook<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>新旧节点updateChildren</li></ul> <div class="language-javascript code-contain extra-class"><pre class="language-javascript"><code>
<span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取 oldCh, newCh 首尾index</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">//获取 oldCh, newCh 首尾node</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span>idxInOld<span class="token punctuation">,</span>elmToMove<span class="token punctuation">,</span>before<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//确保oldStartVnode,oldEndVnode,newStartVnode,newEndVnode存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Vnode might have been moved</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">//当oldStartVnode与newStartVnode属于同一节点</span>
      <span class="token comment">//或者oldEndVnode与newEndVnode属于同一节点</span>
      <span class="token comment">//Vnode 往中间偏移</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">//当oldStartVnode与newEndVnode属于同一节点</span>
      <span class="token comment">//Vnode 往右偏移</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">//当oldEndVnode与newStartVnode属于同一节点</span>
      <span class="token comment">//Vnode 往左偏移</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">//当oldStartVnode,oldEndVnode,newStartVnode,newEndVnode都是不同的节点</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//oldKeyToIdx不存在，则oldCh追加key</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//通过newStartVnode的key去获取idxInOld</span>
        idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//判断idxInOld是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Validator<span class="token punctuation">.</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
          <span class="token comment">//若idxInOld不存在，则为新元素</span>
          <span class="token comment">//创建新元素，并插入到旧节点之前</span>
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//若idxInOld存在，则oldCh有相同 key 的 vnode</span>
          elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">//判断新旧node selector是否相同</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>selector <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//若selector不同，则新建dom</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//若selector相同,key也相同</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将当前 oldCh[idxInOld] 置空，等下次循环到这个下标的时候直接跳过</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> elmToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//处理异常情况，oldCh或newCh还有待处理子项</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//追加newCh</span>
        before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> before<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//删除oldCh</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><div class="tip custom-block"><p>简单来说，新旧节点每次都会进行首首、尾尾、首尾节点的对比，若都不存在，会到旧节点中去匹配是否存在，若不存在，则为新节点；若存在，则打上循环至此跳过的标识，继续进行匹配。</p></div> <h2 id="diff逻辑图"><a href="#diff逻辑图" aria-hidden="true" class="header-anchor">#</a> Diff逻辑图</h2> <img src="/docs/assets/img/vdom_4.c2da2aaa.png" width="100%" class="zoomable"> <h2 id="updatechildren流程图"><a href="#updatechildren流程图" aria-hidden="true" class="header-anchor">#</a> UpdateChildren流程图</h2> <p>因UpdateChildren的逻辑流程较复杂，举个例子来演绎下流程。</p> <p>假定旧节点oldNode=[A,B,C,D],
新节点newNode=[D,B,A,F,E]，oldS、oldE分别代表oldNode首尾项，
newS、newE分别代表newNode首尾项，以节点名（即A,B,C等）为key，整个UpdateChildren的流程如下：</p> <ol><li>oldE与newS为同一节点，newS往右偏移，oldE往左偏移</li></ol> <p><img src="/docs/assets/img/vdom_5.055181bd.png" alt=""></p> <ol start="2"><li>都不为同一节点，取newS所在的B节点到oldCh中匹配，匹配到同一节点，清空oldCh中B节点，newS往右偏移</li></ol> <p><img src="/docs/assets/img/vdom_6.9b64430d.png" alt=""></p> <ol start="3"><li>newS与oldS为同一节点，newS往右偏移，oldS往右偏移</li></ol> <p><img src="/docs/assets/img/vdom_7.826d8ee6.png" alt=""></p> <ol start="4"><li>oldS中B节点为undefined，oldS往右偏移</li></ol> <p><img src="/docs/assets/img/vdom_8.41264b4e.png" alt=""></p> <ol start="5"><li>都不为同一节点，取newS所在的F节点到oldCh中匹配，匹配不到，则为新节点，追加新节点</li></ol> <p><img src="/docs/assets/img/vdom_9.0a70f75f.png" alt=""></p> <ol start="6"><li>oldS大于oldE，updateChildren遍历完，但newCh中还有节点，追加新节点</li></ol> <p><img src="/docs/assets/img/vdom_10.15f83705.png" alt=""></p> <h2 id="总论"><a href="#总论" aria-hidden="true" class="header-anchor">#</a> 总论</h2> <ul><li><p>元素设置key的必要性</p> <p>倘若元素不设置key，oldS、oldE、newS、newE会进行两两对比，若都不相同，则插入新元素newStartNode.elm，newS往右偏移，再进行对比；</p> <p>倘若元素设置key，oldS、oldE、newS、newE同样会进行两两对比，若都不相同，则会用<strong>newS的key去查找oldCh中匹配的节点，如果能匹配到，则进行dom移动，否则，则作为新元素插入，因此可以更加高效利用DOM</strong>。</p></li> <li><p>虚拟DOM并不比操作真实DOM快</p> <p>可以参阅知乎话题 <a href="https://www.zhihu.com/question/31809713/answer/53780674" target="_blank" rel="noopener noreferrer">网上都说操作真实 DOM 慢，但测试结果却比 React 更快，为什么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>综合来说，虚拟DOM的优势并不是在性能层面，但虚拟DOM的性能也不差，具体需要看渲染场景</p></li> <li><p>虚拟DOM解决的前端痛点：<strong>性能均衡、工程效率及平台化</strong></p> <p>在复杂的界面环境下，DOM的操作成本非常高，会频繁触发DOM Reflow 和 Repaint，而虚拟DOM的出现，使得在<strong>真实DOM与Model操作之间建立一道缓冲带</strong>成为可能。翻阅Snabbdom源码，也能看出，虚拟DOM及Diff过程，实质也在操作真实DOM，但通过Diff算法明显<strong>提升了DOM的复用效率</strong>。综合来看，其在<strong>DOM大小更新场景下都能取得极佳的平衡点</strong>。</p> <p>恰恰是虚拟DOM的引入，声明式的前端开发才开始登上舞台。相比命令式的前端开发，声明式<strong>不再需要处理ViewModel，只需关注Model层</strong>即可，极大简化了WebAPP的复杂度，提升了开发效率。</p> <p>虚拟DOM的出现，完成了<strong>Model至View的映射，即UI = Vm（data）</strong>，也打开了函数式的 UI 编程的大门（React）。既然是Model至View的映射，<strong>通过编译工具，能极大提升跨平台性</strong>，使得跨IOS、Android及小程序成为可能（weex、reactNative及mpVue）。</p></li></ul> <h2 id="参考链接"><a href="#参考链接" aria-hidden="true" class="header-anchor">#</a> 参考链接</h2> <ul><li><p><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">snabbdom<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://reactjs.org/docs/reconciliation.html" target="_blank" rel="noopener noreferrer">React Reconciliation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://juejin.im/post/5b9200865188255c672e8cfd" target="_blank" rel="noopener noreferrer">snabbdom 源码阅读分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://zhuanlan.zhihu.com/p/20346379" target="_blank" rel="noopener noreferrer">React 源码剖析系列 － 不可思议的 react diff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.zhihu.com/question/31809713/answer/53780674" target="_blank" rel="noopener noreferrer">网上都说操作真实 DOM 慢，但测试结果却比 React 更快，为什么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h2 id="附录"><a href="#附录" aria-hidden="true" class="header-anchor">#</a> 附录</h2> <p>个人源码分析版本地址：
<a href="https://github.com/Damo-web/vdom" target="_blank" rel="noopener noreferrer">vdom<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Damo-web/docs/edit/master/docs/platform/README.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-03-15 02:36:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/platform/vueLoader.html">Vue Loader</a>→
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.bb5e32e8.js" defer></script><script src="/docs/assets/js/2.3b5bc873.js" defer></script><script src="/docs/assets/js/5.d10ece1f.js" defer></script><script src="/docs/assets/js/22.e56f6488.js" defer></script>
  </body>
</html>
