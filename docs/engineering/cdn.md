# CDN

> 内容分发网络（ Content Delivery Network，可简称为 CDN ）是指一种透过互联网互相连接的计算机网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、影片、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。

## 前言

互联网早期时代，用户量少，带宽低，富媒体资源体量有限，服务器的压力较低。随着互联网的发展，用户量爆炸增长，富媒体资源发展迅速，导致源内容服务器压力越来越大，主干网络拥堵越来越常见。

为解决网络拥堵这一问题，CDN应运而生，其核心理念即将内容缓存在用户周边。直白点说，当用户访问网站时，通过 CDN 负载均衡系统，将此次访问指向至最近的缓存服务器，由该缓存服务器提供网络服务。

CDN 缓存服务器一般称作 CDN 节点，其实跟电商网购平台的物流仓有点类似，为了产品更快到达用户手中，减少用户等待时长，网购订单下达后，会通过电商的物流系统分配最近的发货仓和配送站。同样，CDN 服务商会提供各区域及各运营商 CDN 节点，当用户访问网站时，会根据当前各节点负载情况及访问者的位置信息，分配最合适的节点来分发源内容网站的资源，提高用户访问该网站资源的速度。

## CDN 原理

CDN 的基本流程图如下：

![](./img/cdn_flow.svg)

举个例子，网站 <code>www.snowball.site</code> 中静态资源的预设 CDN 域名为 <code>cdn-static.snowball.site</code>，CDN 服务商提供的 CNAME 地址为 <code>ouyt4c4z5.bkt.clouddn.com</code> ，静态资源的 CDN 域名指向对应的 CNAME 地址这一绑定操作已完成。

CDN 整体分为两大步骤，即 DNS 解析 和 CDN 服务，具体步骤如下：

1. 浏览器访问 <code>cdn-static.snowball.site</code> 下的资源，倘若存在缓存，则直接使用缓存，否则对该域名进行 DNS 解析（ 此处细节可参阅 [域名解析流程](/engineering/domain.html#解析流程) ），通过网站域名服务器查询得知该域名为 CNAME 记录，指向 <code>ouyt4c4z5.bkt.clouddn.com</code> 。

2. 对域名 <code>ouyt4c4z5.bkt.clouddn.com</code> 进行 DNS 查询，由 CDN 服务商的全局负载均衡系统（ Global Server Load Balancing，可简称 GSLB ）给出该域名 A 或 AAAA 记录下 IP 地址 66.42.115.162，即离用户最近的 CDN 边缘节点，至此 DNS 解析流程完成。

3. 对 CDN 边缘节点 66.42.115.162 发起请求，倘若边缘节点存在该静态资源缓存，则直接返回缓存结果，否则向 CDN 中心节点发起请求。

4. CDN 中心节点在其缓存中查询是否存在该静态资源，若存在则返回缓存结果至 CDN 边缘节点，否则回源拉取资源。

5. CDN 中心节点依据设置的回源地址（ 可以是域名或 IP 地址，比如 <code>www.snowball.site</code> ），将请求转发至源站，由源站提供静态资源服务，至此 CDN 服务流程完成。

:::tip 提示
回源地址指预先在 CDN 服务商处配置的源站服务器 IP 或 域名，用于无缓存资源、缓存过期或非缓存资源时，回溯至源站获取资源；回源 HOST 指当源站服务器存在众多站点时，由回源 HOST 决定访问源站服务器上具体站点。需要注意，当回源 HOST 未配置时，默认会将其加速域名（ 以上述 cdn-static.snowball.site 为例 ）作为 回源 HOST；当回源 HOST 配置不正确时，会导致回源失败。
:::

## CDN 命中率



## CDN 链路回源

## CDN 加速

## 参考链接

- [维基百科 - 内容分发网络](https://zh.wikipedia.org/wiki/%E5%85%A7%E5%AE%B9%E5%82%B3%E9%81%9E%E7%B6%B2%E8%B7%AF)

- [到底什么是CDN？](https://zhuanlan.zhihu.com/p/52362950)