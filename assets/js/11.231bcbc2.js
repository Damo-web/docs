(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{215:function(t,s,a){t.exports=a.p+"assets/img/build_1.7139ab77.png"},216:function(t,s,a){t.exports=a.p+"assets/img/build_2.6a19fa4e.png"},217:function(t,s,a){t.exports=a.p+"assets/img/build_3.1b4832f7.png"},218:function(t,s,a){t.exports=a.p+"assets/img/build_4.eebfa0ac.png"},219:function(t,s,a){t.exports=a.p+"assets/img/build_5.80e321a6.png"},220:function(t,s,a){t.exports=a.p+"assets/img/build_6.55314808.png"},221:function(t,s,a){t.exports=a.p+"assets/img/build_7.2898524a.png"},360:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"build-optimization"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#build-optimization","aria-hidden":"true"}},[t._v("#")]),t._v(" Build Optimization")]),t._v(" "),n("blockquote",[n("p",[t._v("之前文章介绍了 CI / CD 相关概念及主流工具，利用此类工具能便捷地进行持续集成及发布，但构建自动化并不意味着构建流程的结束，恰好是构建优化的开始。")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(215),alt:""}})]),t._v(" "),n("h2",{attrs:{id:"缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#缓存","aria-hidden":"true"}},[t._v("#")]),t._v(" 缓存")]),t._v(" "),n("p",[t._v("缓存（ Cache ）是构建流程中必须面对的话题。")]),t._v(" "),n("p",[t._v("在持续集成及发布中，缓存是一把双刃剑，一方面，想尽可能的利用缓存，提升构建速度；一方面，想废弃缓存，确保应用的新鲜度。")]),t._v(" "),n("p",[t._v("以 Node 为例，在 build 之前，需要利用 "),n("code",[t._v("node_modules")]),t._v(" 来提升构建速度，而当 "),n("code",[t._v("package.json")]),t._v(" 中依赖发生变更时，需要清空缓存，安装新增包或更新变更包，确保应用如期运行。")]),t._v(" "),n("p",[t._v("下面以 Drone CI 为例，演示下构建过程中缓存的处理：")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("介于 Drone CI 是容器化的自动化工具，并不能如 Jenkins 直接存储缓存至工作区中，倘若不能存储在工作区，其实很容易想到，可以使用"),n("strong",[t._v("第三方存储")]),t._v("或"),n("strong",[t._v("容器共享文件夹")]),t._v("来实现同样效果。")]),t._v(" "),n("p",[t._v("Drone CI 是基于插件化的自动化工具，缓存相关的插件如下：")]),t._v(" "),n("ul",[n("li",[n("p",[n("a",{attrs:{href:"https://github.com/Drillster/drone-volume-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("Drillster/drone-volume-cache"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/meltwater/drone-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("meltwater/drone-cache"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/drone-plugins/drone-s3-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("drone-plugins/drone-s3-cache"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/hvalle/drone-gcs-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("hvalle/drone-gcs-cache"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/appleboy/drone-sftp-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("appleboy/drone-sftp-cache"),n("OutboundLink")],1)])])]),t._v(" "),n("p",[t._v("从上述插件可以看出，缓存插件也是分为第三方存储（ S3、GCS、SFTP 等 ）和容器共享文件夹 ( volume ) 两大类，当然也有插件对这两项做了融合，比如"),n("code",[t._v("meltwater/drone-cache")]),t._v("插件。")]),t._v(" "),n("p",[t._v("因"),n("code",[t._v("meltwater/drone-cache")]),t._v("插件处理 "),n("code",[t._v("node_modules")]),t._v(" 本地存储时，存在"),n("code",[t._v("node_modules/.bin")]),t._v("文件夹无法缓存的问题（ 可查阅："),n("a",{attrs:{href:"https://github.com/meltwater/drone-cache/issues/39",target:"_blank",rel:"noopener noreferrer"}},[t._v("Allow to configure skipping symbolic links"),n("OutboundLink")],1),t._v(" )，因此采用"),n("code",[t._v("drillster/drone-volume-cache")]),t._v("插件作为本地缓存存储方案。")]),t._v(" "),n("p",[t._v("本文利用主机下"),n("code",[t._v("/var/drone-cache")]),t._v("文件夹来缓存构建时"),n("code",[t._v("node_modules")]),t._v("文件夹，当应用下次构建时可以复用该文件夹下的缓存，从而跳过包安装过程的漫长等待，提升构建速度。"),n("code",[t._v(".drone.yml")]),t._v("示例配置如下：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 详细配置可查阅：https://github.com/Drillster/drone-volume-cache/blob/master/DOCS.md")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 取出存储 cache")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" restore"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drillster/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restore")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./node_modules\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 加载 cache 数据卷，CI服务器对应仓库需要勾选 "Trusted"')]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /cache\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建其他步骤，在此不做显示")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重新存储 cache")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 此步骤一般在发布至远程服务器前执行，用来确保 cache 的新鲜度")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rebuild"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drillster/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rebuild")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./node_modules\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /cache\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 倘若 path 不存在，需要在 CI 服务器上新建相应文件夹")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n")])])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("小贴士")]),t._v(" "),n("p",[t._v("本地存储时，倘若存在多个项目或代码仓库，需要对其缓存做区分，不可如上做简单处理")])])]),t._v(" "),n("li",[n("p",[t._v("完成了缓存的存储后，还需要面对应用新鲜度的问题。当应用的"),n("code",[t._v("package.json")]),t._v(" 中的依赖更新时，需要移除缓存并进行更新。")]),t._v(" "),n("p",[t._v("如何监测依赖更新成为需要解决的问题，方案其实有很多，可以参阅："),n("a",{attrs:{href:"https://stackoverflow.com/questions/52466740/npm-install-if-package-json-was-modified",target:"_blank",rel:"noopener noreferrer"}},[t._v("npm install if package.json was modified"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("通常做法可以分为"),n("strong",[t._v("监测文件变化")]),t._v("（ package.json ）和"),n("strong",[t._v("监测依赖变化")]),t._v("（ package.json 中 dependencies 及 devDependencies ）两大类。")]),t._v(" "),n("p",[t._v("监测依赖变化在实现上复杂点，但缓存的更新会更精确，可以通过比对前后依赖项生成校验文件的 md5 来判定依赖是否发生变更，相关实现可参阅："),n("a",{attrs:{href:"https://github.com/ninesalt/install-changed/blob/master/lib/main.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("ninesalt/install-changed"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("监测文件变化在实现上简单点，可以利用 Git 来实现，可以通过比对前后两次 package.json 文件是否有变动来判定依赖是否发生变更，但往往不太精确，package.json 中非 dependencies 及 devDependencies 部分的变动也会触发清除缓存的操作。")]),t._v(" "),n("p",[t._v("能不能把这两种方式结合起来，取长补短？")]),t._v(" "),n("p",[t._v("在 Node 中，依赖会通过 "),n("code",[t._v("package-lock.json")]),t._v(" 或 "),n("code",[t._v("yarn.lock")]),t._v(" 来锁版本，当依赖变更时，对应的"),n("code",[t._v("package-lock.json")]),t._v(" 或 "),n("code",[t._v("yarn.lock")]),t._v(" 也会更新。可以通过检测 lock 文件变化来判定依赖是否发生变更。")]),t._v(" "),n("p",[t._v("在发布版本时，通常会利用 npm version 命令进行版本更新，此时 "),n("code",[t._v("package-lock.json")]),t._v(" 中 version 字段也会更新，并不能满足预期。而"),n("code",[t._v("yarn.lock")]),t._v("不会因 npm version 命令进行文件更新，只有当 dependencies 及 devDependencies 变动时才会更新。")]),t._v(" "),n("p",[t._v("通过以上的对比，宜采用 yarn 来管理包，并监测 "),n("code",[t._v("yarn.lock")]),t._v(" 文件的变化来更新缓存。")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pre-install.sh 文件")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/bash")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 判断当前与上次提交中 yarn.lock 是否有变化")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("changes")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" HEAD^ HEAD -- yarn.lock"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" -n "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$changes")]),t._v('"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*** CHANGES FOUND ***"')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$changes")]),t._v('"')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Yarn.lock has changed"')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 因 drillster/drone-volume-cache 并不可控，此处删除拉取后的缓存，以保证包的新鲜度")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf ./node_modules\n   "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*** CHANGES NOT FOUND ***"')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Yarn.lock keep unchanged"')]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),n("div",{staticClass:"language-yaml extra-class"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" restore"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drillster/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restore")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n           "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./node_modules\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n           "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /cache\n   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行上述 sh 脚本")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n     "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node\n     "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bash ./pre"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("install.sh\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rebuild"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drillster/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("volume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rebuild")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n           "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./node_modules\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n         "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n           "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /cache\n "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cache\n     "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n")])])])])]),t._v(" "),n("h2",{attrs:{id:"分发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分发","aria-hidden":"true"}},[t._v("#")]),t._v(" 分发")]),t._v(" "),n("p",[t._v("之前博客的自动化部署主要是以 github pages 为载体，但在实际部署过程中需要分发代码至各服务器。")]),t._v(" "),n("p",[t._v("在 Jenkins CI 中，这一操作通常利用 Publish Over SSH 插件来进行完成，大致过程如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 连接 Jenkins CI VPC（ Virtual Private Cloud ）网络")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# VPC 通常称为私有网络或者专有网络，更加安全，自定义度更高")]),t._v("\nSSH: Connecting from "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-jenkins-ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# configuration 中即为分发服务器的配置项")]),t._v("\nSSH: Connecting with configuration "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-web-prod-1-172.36.13.46"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里利用管道来传输文件，即压缩文件至 STDOUT ")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 再利用 SSH 连接 Web服务器，拷贝并解压传输文件至对应文件夹，并删除压缩的传输文件")]),t._v("\nSSH: EXEC: STDOUT/STDERR from "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("cd /var/www/web/docs\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xzf docs.tar.gz -C /var/www/web/docs\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f docs.tar.gz"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nSSH: EXEC: completed after "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("501")]),t._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 完成后断开连接，继续执行分发任务")]),t._v("\nSSH: Disconnecting configuration "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-web-prod-1-172.36.13.46"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nSSH: Transferred "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" file"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nSSH: Connecting from "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-jenkins-ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nSSH: Connecting with configuration "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-web-prod-2-172.16.26.115"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nSSH: EXEC: STDOUT/STDERR from "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("cd /var/www/web/docs\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xzf docs.tar.gz -C /var/www/web/docs\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f docs.tar.gz"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nSSH: EXEC: completed after "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),t._v(" ms\nSSH: Disconnecting configuration "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("vpc-web-prod-2-172.16.26.115"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nSSH: Transferred "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" file"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nBuild step "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Send files or execute commands over SSH'")]),t._v(" changed build result to SUCCESS\nFinished: SUCCESS\n")])])]),n("p",[t._v("概括来说，CI 服务器需先通过 SSH 连接 Web 服务器，分发时再传输文件至对应的 Web 服务器。")]),t._v(" "),n("p",[t._v("以 Drone CI 为例，具体步骤如下：")]),t._v(" "),n("ol",[n("li",[t._v("在 CI 服务器下生成无密码的 Public SSH Keys")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行命令，下述结果仅为执行参考")]),t._v("\n$ ssh-keygen\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行结果")]),t._v("\nGenerating public/private rsa key pair.\nEnter "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("which")]),t._v(" to save the key "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("/root/.ssh/id_rsa"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# passphrase 为 key 的密码，默认设置空 ，表示不需要密码")]),t._v("\nEnter passphrase "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("empty "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" no passphrase"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\nEnter same passphrase again:\nYour identification has been saved "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /root/.ssh/id_rsa.\nYour public key has been saved "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\nSHA256:YwhPC9gxq6OPmVJ7XYiKI257bSPPnfpdBc root@snowball\nThe key's randomart image is:\n+---"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("RSA "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("----+\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   o*o           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  oo."),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(".          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("o"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("+ o.o"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("+o.        "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" +o. ++oS.E      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("+"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(".o + "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(".oo+. "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("       "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("+"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(".          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+----"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("SHA256"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("-----+\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看私钥")]),t._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /root/.ssh/id_rsa\n-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAs1rxWQZzK+pOLbXY7vdLMoMfA85QVavrwuR06RksLImlFiXj\nlDLhmYZUUijspp1Zw775+9VQxldejiCsL3mhzWSJPJ9wO5TJi1CXLn5QsEjY39dC\ns5SEVq1EhqnVN0fjQqHaJn8GOOfy5bvzyTmV8WgO8Pl4CeR5vuuQbRYFDP+rjQnH\nzLpeq73FiWASMRT5vIrZ1Rk92JoGN7TtBdI3ipP+O1kMimO0sATB9Rruww+lpuuZ\n63jbHjPfmY24czMHbtbkpNjyDZNyvC7Mi2RNuIwcDkz4LQOJuWni\n-----END RSA PRIVATE KEY-----\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看公钥")]),t._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" id_rsa.pub\nssh-rsa AAAAB3NzaC1yc2EAA2gQNDCo99NsjZzrkYYRZ4Uohrgt8LPXxTF0Zr3 root@snowball\n\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[t._v("复制 Public SSH Keys ，登录 Web 服务器，保存至 "),n("code",[t._v("~/.ssh/authorized_keys")]),t._v(" 文件")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" root@45.88.74.102 "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mkdir -p .ssh && cat >> .ssh/authorized_keys'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" ~/.ssh/id_rsa.pub\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 成功后退出登录的 Web 服务器")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在 CI 服务器通过 SSH 连接 Web 服务器，免密可登录则表示设置成功")]),t._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v(" root@45.88.74.102\n")])])]),n("ol",{attrs:{start:"3"}},[n("li",[n("p",[t._v("配置 Drone CI 仓库设置项")]),t._v(" "),n("p",[n("img",{attrs:{src:a(216),alt:""}})]),t._v(" "),n("p",[t._v("REMOTE_HOST 为第一台 Web 服务器 IP 地址，REMOTE_HOST2 为第二台 Web 服务器 IP 地址，以此类推；RSYNC_KEY 为 CI 服务器 Private SSH Key；RSYNC_USER 为 Web 服务器用户名，通常为 root")])]),t._v(" "),n("li",[n("p",[t._v("配置 "),n("code",[t._v(".drone.yml")]),t._v(" 文件")]),t._v(" "),n("p",[t._v("服务器间数据传输存在 rsync、nc、ftp、scp、nfs 等多种方式，本文采用 rsync 来传输数据。")]),t._v(" "),n("p",[t._v("rsync 是一个远程数据同步工具，可以通过 LAN/WAN 快速同步多台主机间的文件。rsync 使用 rsync 算法来保持本地和远程两个主机间的文件同步，只传送两个主机同一文件的不同部分，而不是每次全量更新，这种增量更新的方式，提升了文件传输的速度。")]),t._v(" "),n("p",[t._v("Drone CI 中一般使用 "),n("a",{attrs:{href:"https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("drillster/drone-rsync"),n("OutboundLink")],1),t._v(" 插件来传输服务器间数据。示例如下：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rsync\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drillster/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rsync\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RSYNC_KEY")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RSYNC_KEY\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RSYNC_USER")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RSYNC_USER\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("REMOTE_HOST")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" REMOTE_HOST\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("REMOTE_HOST2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" REMOTE_HOST2\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" $$REMOTE_HOST\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" $$REMOTE_HOST2\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./dist\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 需要在 Web 服务器上安装 nginx")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# nginx 默认静态资源文件夹")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/nginx/html\n")])])])])]),t._v(" "),n("h2",{attrs:{id:"容器化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#容器化","aria-hidden":"true"}},[t._v("#")]),t._v(" 容器化")]),t._v(" "),n("p",[t._v("上面从缓存和分发角度优化了构建流程，使得整个构建更加自动化、速度更快。总体来说，以上的优化已经能满足日常构建的大部分场景。但倘若思考下整个构建流程，优化依然可以继续。")]),t._v(" "),n("p",[t._v("目前来说，利用 Drone 部署远程 CI 服务器，所有的构建都是在容器内进行，已经完成了环境隔离，保障了本地与远程构建结果的一致性。")]),t._v(" "),n("p",[t._v("稍微回望这一流程，拉取远端代码，构建产出 dist 目录的过程，其实是可以采用 Dockerfile 文件生成 dist 静态镜像来解决。Dockerfile 文件如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("FROM node:alpine as builder\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注入环境变量")]),t._v("\nENV PROJECT_ENV production\nENV NODE_ENV production\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新建工作目录")]),t._v("\nWORKDIR /src\nWORKDIR /src-build\nADD ./ /src-build/\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行构建命令")]),t._v("\nRUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" run build "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v("  /src-build/dist /src/ "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /src-build\n")])])]),n("p",[t._v("如上利用 Dockerfile 可以不需引入 CI 服务器，即可完成打包的操作。")]),t._v(" "),n("p",[t._v("倘若不引入 CI 服务器，利用 Dockerfile 来进行打包同样要处理缓存和分发问题：每次构建时，"),n("code",[t._v("yarn install")]),t._v(" 都需要重新执行一遍，安装导致的时间和安全成本巨大；分发的话，需要通过上传镜像至私有 Docker 镜像仓库，再进入 Web 服务器执行拉取镜像并运行容器的操作。")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("回顾前端构建的流程，只需要保障 Node版本 、yarn版本 及 node_modules 文件夹一致，即可保证生成 dist 文件的一致。那么，是不是可以把这三者做成 Node 基础镜像来为 Web 服务器端的构建服务。")]),t._v(" "),n("p",[t._v("因需要区分 Node 基础镜像和其他构建镜像，新建 "),n("code",[t._v("node.dockerfile")]),t._v("，如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取 node 镜像")]),t._v("\nFROM node:alpine\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# alpine 版本不包含 git 和 docker")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 但后续在此镜像中需要使用 git 和 docker，安装后体积会增加一倍")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 也可以不安装，在运行镜像时安装，主要还是在于镜像体积的取舍")]),t._v("\nRUN apk update "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" apk "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" --no-cache "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    apk "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" docker\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新建并进入工作区")]),t._v("\nRUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /src\nWORKDIR /src\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制当前 package.json 相关文件至工作区")]),t._v("\nCOPY ./package*.json /src/\nCOPY ./yarn.lock /src/\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装包")]),t._v("\nRUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --production\n")])])]),n("p",[t._v("在当前目录下执行构建镜像，如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建 Node 基础镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -t 镜像的 tag")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -f Dockerfile 的名字 (默认为 ‘Dockerfile’)")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .  代表当前文件夹的所有文件，并发送至 Docker daemon")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 具体可查阅：https://docs.docker.com/v17.12/engine/reference/commandline/build/")]),t._v("\n$ docker build -t node-base -f node.dockerfile "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建过程")]),t._v("\nSending build context to Docker daemon  "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("133")]),t._v(".4MB\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" FROM node:alpine\nalpine: Pulling from library/node\ne7c96db7181b: Pull complete \n773afe93be0d: Pull complete \n223db68b3560: Pull complete \n"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("609526630549")]),t._v(": Pull complete \nDigest: sha256:25d56cf8f21a33f61415bcde0dd7fb1e1d46ecdb9b3b6d39e4846570cc235a81\nStatus: Downloaded newer image "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" node:alpine\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" d4edda39fb81\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" RUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /src\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 6c79b449d11f\nRemoving intermediate container 6c79b449d11f\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 7b232a36912b\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" WORKDIR /src\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 2c91d05c5d08\nRemoving intermediate container 2c91d05c5d08\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" e031c4db6733\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" COPY ./package*.json /src/\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" b24da7a66597\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" COPY ./yarn.lock /src/\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 967926c6ebaf\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("/6 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" RUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --production\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 8d75cadf2142\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" v1.16.0\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Resolving packages"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Fetching packages"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ninfo fsevents@1.2.9: The platform "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"linux"')]),t._v(" is incompatible with this module.\ninfo "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fsevents@1.2.9"')]),t._v(" is an optional dependency and failed compatibility check. Excluding it from installation.\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Linking dependencies"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Building fresh packages"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nDone "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("120")]),t._v(".07s.\nRemoving intermediate container 8d75cadf2142\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" defa3914799b\nSuccessfully built defa3914799b\nSuccessfully tagged node-base:latest\n")])])]),n("p",[t._v("这样便完成了 Node 基础镜像的制作，但本地镜像并不能共享，而各环境倘若需要保证一致性的话，需要引用同一基础镜像，此时可以上传至 Docker hub 公有或私有仓库，或利用"),n("a",{attrs:{href:"https://github.com/goharbor/harbor",target:"_blank",rel:"noopener noreferrer"}},[t._v(" Harbor "),n("OutboundLink")],1),t._v("搭建公司镜像管理平台，或利用阿里云等云服务商提供的镜像仓库服务。比较推荐 Harbor 自建镜像管理平台，保障镜像服务的安全性和稳定性。")]),t._v(" "),n("p",[t._v("基础镜像线上化后，不需要安装任何环境和包，只需执行构建即可，缓存问题迎刃而解，而且方便追踪及复现线上故障，可谓一箭双雕。")])]),t._v(" "),n("li",[n("p",[t._v("回望分发 Web 服务器时，直接传输 dist 到 nginx 默认文件夹，需要预先在服务器上配置 nginx 环境及配置文件，当 Web 服务器增多后，这一阶段比较繁琐，也容易出错。")]),t._v(" "),n("p",[t._v("倘如部署时，只需运行 Docker 镜像便能访问 Web 服务，就能轻松地进行服务器扩展及收缩，也方便在本地追踪和复现线上问题。")]),t._v(" "),n("p",[t._v("之前的 Dockerfile 其实可以一拆为三，分为 Node 基础镜像、Dist 静态镜像及 Nginx 部署镜像。因 Nginx 部署镜像仅需 Dist 静态镜像提供配置文件及静态资源，可以利用 Docker 的多阶段构建将两镜像进行合并。")]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("小贴士")]),t._v(" "),n("p",[t._v("Docker 的多阶段构建只会保留最后阶段的文件和命令，可查阅"),n("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[t._v(" docker | multistage-build "),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("在当前目录下，新建 "),n("code",[t._v("web.dockerfile")]),t._v("，如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取 node 基础镜像")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里以本地镜像为例")]),t._v("\nFROM node-base as builder\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入 node 基础镜像下 src 目录")]),t._v("\nWORKDIR /src\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制当前目录文件至 src 目录下")]),t._v("\nCOPY "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" /src/\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 打包静态资源")]),t._v("\nRUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" build\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取 nginx 基础镜像")]),t._v("\nFROM nginx:alpine\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新建工作区")]),t._v("\nWORKDIR /root \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制 builder 阶段 /src/dist 文件至当前 nginx 目录 docs 下")]),t._v("\nCOPY --from"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("builder /src/dist /usr/share/nginx/html/docs\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 暴露端口（ nginx 基础镜像默认 80 端口，可忽略 ）")]),t._v("\nEXPOSE "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" \n")])])]),n("p",[t._v("在当前目录下执行构建镜像，如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ docker build -t web-nginx -f web.dockerfile "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建过程")]),t._v("\nSending build context to Docker daemon  "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("133")]),t._v(".4MB\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" FROM node-base as builder\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" defa3914799b\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" WORKDIR /src\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Using cache\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 7bec27b99d51\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" COPY "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" /src/\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" b90d93e4aa54\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" RUN "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" build\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 0e50b49dda4d\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" run v1.16.0\n$ vuepress build docs\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait")]),t._v(" Extracting site metadata"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply theme @vuepress/theme-default "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin container "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vuepress-plugin-container"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/register-components "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-register-components"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/active-header-links "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-active-header-links"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/search "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-search"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/nprogress "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-nprogress"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/pwa "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-pwa"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/last-updated "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-last-updated"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/back-to-top "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-back-to-top"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\ntip Apply plugin @vuepress/medium-zoom "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i.e. "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@vuepress/plugin-medium-zoom"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nℹ Compiling Client\nℹ Compiling Server\n✔ Server: Compiled successfully "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(".89s\n✔ Client: Compiled successfully "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(".04s\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait")]),t._v(" Rendering static HTML"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait")]),t._v(" Generating "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nsuccess Generated static files "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" dist.\n\nDone "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(".70s.\nRemoving intermediate container 0e50b49dda4d\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" c8270562d518\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" FROM nginx:alpine\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" bfba26ca350c\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" WORKDIR /root\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Using cache\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" bbea1e258a05\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" COPY --from"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("builder /src/dist /usr/share/nginx/html\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 600974ff3c47\nStep "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("/8 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" EXPOSE "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 387166dcd7c4\nRemoving intermediate container 387166dcd7c4\n---"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 75e21d8027cc\nSuccessfully built 75e21d8027cc\nSuccessfully tagged web-nginx:latest\n")])])]),n("p",[t._v("接下来把该镜像上传到镜像仓库，在各预装 docker 的 Web 服务器上直接拉取并运行就行了。")])])]),t._v(" "),n("p",[t._v("整理完思路，但单靠上述容器化的实践并不能实现自动化部署的工作，将容器化理念融入进 Drone CI 工作流中才是务实之举。")]),t._v(" "),n("p",[t._v("之前利用 Drone Plugin 的功能，完成了缓存和分发的工作。其实容器化之后也大同小异，但需要对 "),n("code",[t._v(".drone.yml")]),t._v(" 文件进行相应变更，细节如下：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("取消 CI 服务器本地缓存 node_modules 文件的策略，使用远程 docker image 来取代")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .drone.yml")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 私有镜像，这里采用 harbor 来进行存储和管理")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 细节可参阅：https://github.com/goharbor/harbor")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 必须配置 image_pull_secrets，否则会出错")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" harbor.snowball.site/web/node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("base\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 挂载主机 daemon 用来 tag")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dockersock\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/run/docker.sock\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_USERNAME")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_USERNAME\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_PWD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_PWD\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 倘若 node 基础镜像没内置 git 和 docker，需要进行安装")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - apk add --no-cache git")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - apk add docker")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 登陆私有镜像仓库（ 倘若是公有仓库则可以忽略 ）")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker login harbor.snowball.site "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $$HARBOR_USERNAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p $$HARBOR_PWD\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行 auto-check-install.sh 脚本来检测缓存变更")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# web.dockerfile 宜采用本地镜像，如 node-base ，保证缓存的新鲜度")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sh ./build/auto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("install.sh\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建 web-nginx 镜像并推送至远程")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f web.dockerfile .\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker tag web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx harbor.snowball.site/web/web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push harbor.snowball.site/web/web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 清除 Web 服务器 untagged images")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker rmi $(docker images "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('filter "dangling=true" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("trunc)\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 容许容器访问主机服务")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置私有镜像仓库授权信息")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 通过 docker login [SERVER] 后，可通过 ~/.docker/config.json 获取授权信息")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 注意密码采用 -p 登陆，使用 --password-stdin 登陆将无法获取授权信息")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 具体配置可参阅：https://discourse.drone.io/t/1-0-0-rc1-how-to-pull-image-from-private-registry-and-execute-commands-in-it/3057/12")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image_pull_secrets")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dockerconfigjson\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# auto-check-install.sh")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/bash")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" CHECKING FOR CHANGES "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("changes")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" HEAD^ HEAD -- yarn.lock"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" -n "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$changes")]),t._v('"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*** CHANGES FOUND ***"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$changes")]),t._v('"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Yarn.lock has changed"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 依赖变更时，需要构建新 node-base 镜像并推送至远程私有仓库")]),t._v("\n    docker build -t node-base -f node.dockerfile "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n    docker tag node-base harbor.snowball.site/web/node-base\n    docker push harbor.snowball.site/web/node-base\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*** CHANGES NOT FOUND ***"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Yarn.lock has not changed"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("取消 CI 服务器传输文件至远程 Web 服务器的策略，使用拉取远程 docker image 来取代")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .drone.yml")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" publish"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  使用 drone-ssh 插件连接远程服务器")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" appleboy/drone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ssh\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_USERNAME")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_USERNAME\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_PWD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_PWD\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 目前不支持 environment 存取")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 45.77.119.141\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 144.202.103.102\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" REMOTE_USER\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" REMOTE_KEY\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 暴露至 script 的环境变量")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("envs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" HARBOR_USERNAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("HARBOR_PWD "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("v\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 判断是否存在 web-server 容器，存在则停止并删除原有 container")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker ps "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('filter "name=web'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('server" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" grep "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('q . && (echo "Docker container web'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('server is existed" && docker container stop web'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server && docker rm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server) "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(' echo "Docker container web'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('server is not existed"\n      '),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拉取最新镜像并运行")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker login harbor.snowball.site "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $$HARBOR_USERNAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p $$HARBOR_PWD\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker pull harbor.snowball.site/web/web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 3080"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("80 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server harbor.snowball.site/web/web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 清除 Web 服务器 untagged images")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker rmi $(docker images "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('filter "dangling=true" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("trunc)\n")])])])])]),t._v(" "),n("p",[t._v("至此，Drone CI 容器化大致完成。但需要注意，刚部署项目时，本地和远程都未暂存基础镜像，需要在 build-web-image 步骤前追加 check-base-image 的步骤：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .drone.yml")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" check"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("base"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("dind\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 挂载主机 daemon 用来 tag")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dockersock\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/run/docker.sock\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_USERNAME")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_USERNAME\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBOR_PWD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("from_secret")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HARBOR_PWD\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker login harbor.snowball.site "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $$HARBOR_USERNAME "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p $$HARBOR_PWD\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sh ./build/auto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("image.sh\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# auto-check-image.sh")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/bash")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" CHECKING FOR NODE BASE IMAGE "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("docker images -q node-base "),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),t._v(" /dev/null"),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" -n "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$image")]),t._v('"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Docker image node-base is existed"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Docker image node-base is not existed"')]),t._v("\n  docker build -t node-base -f node.dockerfile "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n  docker tag node-base harbor.snowball.site/web/node-base\n  docker push harbor.snowball.site/web/node-base\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),n("p",[t._v("需要说明的是，Dockerfile 构建时每行命令都是 Layer，Docker 构建时使用 Layer Cache 可以加速镜像构建过程，无需担心构建所产生的时间成本。整体构建用时与之前不相伯仲，如下图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(217),alt:""}})]),t._v(" "),n("p",[t._v("容器化完成之后，基础镜像和服务镜像都存放至 Harbor 私有仓库，如下图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(218),alt:""}})]),t._v(" "),n("p",[t._v("基于此，可以便捷地复用和管理镜像，方便追踪及复现线上故障，增强了 Web 服务的伸缩性。")]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[t._v("小贴士")]),t._v(" "),n("p",[t._v("在实际工作中，Harbor 中的镜像可以通过 tag 来区分版本号，以利于回滚，此处只用作简单演示")])]),t._v(" "),n("h2",{attrs:{id:"体积"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#体积","aria-hidden":"true"}},[t._v("#")]),t._v(" 体积")]),t._v(" "),n("p",[t._v("应用的体积是构建时需要面对的棘手问题，在前端服务中，主要体现在 npm 包和 Docker 镜像两方面：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("npm 包")]),t._v(" "),n("p",[t._v("npm 包分为 devDependencies 和 dependencies 两种依赖，其中 devDependencies 是日常开发环境所依赖的包，在部署时其实并不需要安装。")]),t._v(" "),n("p",[t._v("可以通过一下命令来优化 node_modules 文件夹的体积：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yarn")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 只安装 dependencies 中的包")]),t._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --production\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# npm ")]),t._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" prune --production\n")])])])]),t._v(" "),n("li",[n("p",[t._v("Docker 镜像")]),t._v(" "),n("p",[t._v("Docker 镜像也存在大小之分，比如，Docker Hub 上就存在多个 Node 镜像，不同的镜像具有不同的大小，而在容器时代，Alpine 是最轻量的镜像，因此可以把基础镜像都采用 Alpine 版本，这样生成的镜像足够小，便于推送和拉取。")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Dockerfile 中拉取 Alpine 版本")]),t._v("\nFROM node:alpine\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# or")]),t._v("\nFROM nginx:alpine\n")])])])])]),t._v(" "),n("h2",{attrs:{id:"网络"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#网络","aria-hidden":"true"}},[t._v("#")]),t._v(" 网络")]),t._v(" "),n("p",[t._v("在网络层面，国内访问 npm 镜像源、Docker 镜像源 及 Github 仓库并不稳定，速度堪忧。这可能会导致 npm 包安装失败、Docker 镜像拉取失败、Github 仓库推送代码失败或过慢等问题。")]),t._v(" "),n("p",[t._v("当然，解决方案也有很多，可以采用国外云服务器、引用国内镜像源或利用网络代理来解决。")]),t._v(" "),n("p",[t._v("国内镜像源其实并不能解决 Github 仓库推送问题，而网络代理在 Docker 容器中存在诸多问题，推荐采用国外云服务器来解决。")]),t._v(" "),n("p",[t._v("同等配置下的国外云服务和国内阿里云服务器部署的 Drone CI ，无 node_modules 缓存，同次构建耗时依次如下：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(219),alt:""}})]),t._v(" "),n("p",[t._v("国外云服务构建详细信息：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(220),alt:""}})]),t._v(" "),n("p",[t._v("国内阿里云服务器构建详细信息：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(221),alt:""}})]),t._v(" "),n("p",[t._v("对比可见，主要耗时集中于 yarn install 和 deploy github 这两个阶段。 在拉取 Docker 镜像时，国内阿里云服务器偶尔会抛出无法获取镜像的错误，如下：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: request canceled "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" waiting "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" connection "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Client.Timeout exceeded "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" awaiting headers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("为解决国内网络问题带来的构建用时成本，倘若条件容许，可以自建代码仓库（ GitLab、Gogs、Gitea 等 ）、自建 npm 服务器（ sinopia、cnpm 等 ）及自建 dokcer 镜像仓库（ harbor等 ）来避免。")]),t._v(" "),n("p",[t._v("倘若条件不容许，针对 npm 官方源 和 Docker 镜像源，可以采用国内镜像源来简单处理：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("npm 镜像源")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" config "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://registry.npm.taobao.org"')]),t._v("\n")])])])]),t._v(" "),n("li",[n("p",[t._v("Docker 镜像源")]),t._v(" "),n("p",[t._v("在 Linux 云服务的"),n("code",[t._v("/etc/docker/daemon.json")]),t._v("文件下写入如下信息：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# daemon.json 倘若不存在则新建")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"registry-mirrors"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://dockerhub.azk8s.cn"')]),t._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://reg-mirror.qiniu.com"')]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("重启 Docker 服务：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 以 root 权限运行")]),t._v("\n$ systemctl daemon-reload\n$ systemctl restart docker\n")])])])])]),t._v(" "),n("h2",{attrs:{id:"参考链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考链接","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),n("ul",[n("li",[n("p",[n("a",{attrs:{href:"https://laszlo.cloud/the-ultimate-droneci-caching-guide",target:"_blank",rel:"noopener noreferrer"}},[t._v("The ultimate DroneCI caching guide"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://underthehood.meltwater.com/blog/2019/04/10/making-drone-builds-10-times-faster/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Making Drone Builds 10 Times Faster!"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://shanyue.tech/post/deploy-frontend-with-docker/",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何使用 docker 高效部署前端应用"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"http://trylife.cn/drone-ci/vue-continuous-deploy-to-aliyun-oss/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Drone 将 VUE 项目持续部署到阿里云 OSS"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://avnpc.com/pages/speed-up-drone-ci-workflow",target:"_blank",rel:"noopener noreferrer"}},[t._v("容器环境持续集成优化，Drone CI 提速 500%"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"http://imhxl.com/post/docker-frontend-project.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端项目容器化之旅"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://stackoverflow.com/questions/52466740/npm-install-if-package-json-was-modified",target:"_blank",rel:"noopener noreferrer"}},[t._v("npm install if package.json was modified"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://stackoverflow.com/questions/41371090/git-show-file-diff-between-head-and-initial-first-version",target:"_blank",rel:"noopener noreferrer"}},[t._v("Git - show file diff between HEAD and initial (first) version"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://stackoverflow.com/questions/9903541/finding-diff-between-current-and-last-version",target:"_blank",rel:"noopener noreferrer"}},[t._v("Finding diff between current and last version?"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://medium.com/@amy/ssh-rsync-and-tar-8812a5a47410",target:"_blank",rel:"noopener noreferrer"}},[t._v("ssh, rsync, and tar"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://blog.csdn.net/gatieme/article/details/51673229",target:"_blank",rel:"noopener noreferrer"}},[t._v("两台Linux系统之间传输文件的几种方法"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://discourse.drone.io/t/build-not-running-on-tag/3376",target:"_blank",rel:"noopener noreferrer"}},[t._v("Build not running on tag"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://discourse.drone.io/t/cannot-execute-a-pipeline-on-either-tag-or-push-to-specific-branch/3490/4",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cannot execute a pipeline on either tag or push to specific branch"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://www.hi-linux.com/posts/55545.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker 最佳实践之多阶段构建"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/39209596",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么不能在服务器上 npm install ？"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"http://paislee.io/how-to-build-and-deploy-docker-images-with-drone/",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to Build and Deploy Docker Images with Drone"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://discourse.drone.io/t/1-0-0-rc1-how-to-pull-image-from-private-registry-and-execute-commands-in-it/3057/12",target:"_blank",rel:"noopener noreferrer"}},[t._v("[1.0.0-rc1] How to pull image from private registry and execute commands in it"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://www.projectatomic.io/blog/2016/03/docker-credentials-store/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Credential Store"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/nodejs/docker-node/issues/586",target:"_blank",rel:"noopener noreferrer"}},[t._v("git not found in alpine image"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://github.com/appleboy/drone-ssh/issues/130",target:"_blank",rel:"noopener noreferrer"}},[t._v("Secret in Drone 1.0.0-rc.1"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://yeasy.gitbooks.io/docker_practice/install/mirror.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker practice"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://community.atlassian.com/t5/Bitbucket-questions/Piplenes-docker-login-can-not-perform-an-interactive-login-from/qaq-p/595736",target:"_blank",rel:"noopener noreferrer"}},[t._v("Piplenes: docker login can not perform an interactive login from a non TTY"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://stackoverflow.com/questions/33913020/docker-remove-none-tag-images",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker remove none TAG images"),n("OutboundLink")],1)])]),t._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://stackoverflow.com/questions/38576337/how-to-execute-a-bash-command-only-if-a-docker-container-with-a-given-name-does",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to execute a Bash command only if a Docker container with a given name does not exist?"),n("OutboundLink")],1)])])])])},[],!1,null,null,null);s.default=e.exports}}]);